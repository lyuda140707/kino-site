<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#00fff2">

  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icon-512.png">

  <title>üé¨ –ó–±—ñ—Ä–∫–∞ ‚Äî Relax Kino</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Supabase lib -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- –¢–≤—ñ–π —î–¥–∏–Ω–∏–π –∫–ª—ñ—î–Ω—Ç (–í–ê–ñ–õ–ò–í–û: —Å–∞–º–µ –≤—ñ–Ω –º–∞—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ window.supabaseClient) -->
  <script src="supabase-client.js"></script>

  <style>
    body { background:#000; color:#fff; font-family:Poppins, sans-serif; }
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .title{font-size:28px;font-weight:800;color:#00fff2;margin:20px 0 10px;text-shadow:0 0 12px rgba(0,255,255,.25)}
    .subtitle{color:#aaa;margin-bottom:18px}

    .film-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(180px,1fr));
      gap:16px;
    }
    .film-card{
      background:#111;border:1px solid rgba(0,255,255,0.15);
      border-radius:12px; overflow:hidden; cursor:pointer;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .film-card:hover{transform:scale(1.03);box-shadow:0 0 18px rgba(0,255,255,.15)}
    .film-card img{width:100%;height:260px;object-fit:cover;display:block}
    .film-card h3{margin:10px;font-size:14px;color:#fff;text-align:center;line-height:1.25}
    .badge-pro{
      position:absolute;top:10px;right:10px;
      background:rgba(0,0,0,.75); color:#00fff2;
      padding:4px 8px;border-radius:8px;font-size:12px;font-weight:800;
      border:1px solid rgba(0,255,255,.35); backdrop-filter:blur(4px);
    }

    #pagination{display:flex;justify-content:center;gap:6px;flex-wrap:wrap;margin:20px 0 35px}
    .page-btn{
      background:linear-gradient(145deg,#0b0b0b,#151515);
      border:1px solid rgba(0,255,255,.35);
      color:#00fff2;border-radius:10px;padding:8px 14px;
      font-size:14px;font-weight:700;cursor:pointer;transition:.2s;
      box-shadow:0 0 8px rgba(0,255,255,.18)
    }
    .page-btn:hover{background:linear-gradient(145deg,#00fff2,#00b5b0);color:#000;transform:scale(1.06)}
    .page-btn.active{background:linear-gradient(145deg,#00fff2,#00b5b0);color:#000}
    .page-btn:disabled{opacity:.4;cursor:not-allowed;box-shadow:none}

    footer{text-align:center;color:#777;padding:18px 0}
  </style>
</head>

<body>
  <div id="header-placeholder"></div>
  <script src="header.js"></script>

  <div class="wrap">
    <div class="title" id="collectionTitle">üé¨ –ó–±—ñ—Ä–∫–∞</div>
    <div class="subtitle" id="collectionSubtitle">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>

    <div class="film-grid" id="filmGrid"></div>
    <div id="pagination"></div>

    <footer>¬© 2025 Relax Kino</footer>
  </div>

  <!-- —è–∫—â–æ —Ñ–∞–π–ª—ñ–≤ –Ω–µ–º–∞—î ‚Äî –¢–†–ò–ú–ê–ô –í–ò–ú–ö–ù–ï–ù–ò–ú–ò -->
  <!-- <script src="/sw-register.js"></script> -->
  <!-- <script src="/pull-refresh.js"></script> -->

  <script src="auth.js"></script>
  <script src="seo.js"></script>

  <script>
    console.log("‚úÖ –°—Ç–æ—Ä—ñ–Ω–∫–∞ –∑–±—ñ—Ä–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞");
    if (!window.supabaseClient) {
      console.error("‚ùå supabaseClient –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π. –ü–µ—Ä–µ–≤—ñ—Ä supabase-client.js");
    }

    const params = new URLSearchParams(location.search);
    const name = decodeURIComponent(params.get("name") || params.get("collection") || "");

    const titleEl = document.getElementById("collectionTitle");
    const subEl   = document.getElementById("collectionSubtitle");
    const grid    = document.getElementById("filmGrid");
    const pagEl   = document.getElementById("pagination");

    titleEl.textContent = name ? `üé¨ ${name}` : "üé¨ –ó–±—ñ—Ä–∫–∞";

    let currentPage = 1;
    const perPage = 30;
    let allItems = [];

    function renderPagination(total) {
      const totalPages = Math.ceil(total / perPage);
      pagEl.innerHTML = "";
      if (totalPages <= 1) return;

      const makeBtn = (label, page, opts={}) => {
        const b = document.createElement("button");
        b.className = "page-btn";
        b.textContent = label;
        if (opts.active) b.classList.add("active");
        if (opts.disabled) b.disabled = true;
        b.onclick = () => {
          if (b.disabled) return;
          currentPage = page;
          renderCards();
          window.scrollTo({top:0,behavior:"smooth"});
        };
        return b;
      };

      pagEl.appendChild(makeBtn("‚óÄ", Math.max(1, currentPage-1), {disabled: currentPage===1}));

      const visible = 5;
      let start = Math.max(1, currentPage - Math.floor(visible/2));
      let end = Math.min(totalPages, start + visible - 1);
      if (end - start + 1 < visible) start = Math.max(1, end - visible + 1);

      for (let p=start; p<=end; p++) pagEl.appendChild(makeBtn(String(p), p, {active: p===currentPage}));

      pagEl.appendChild(makeBtn("‚ñ∂", Math.min(totalPages, currentPage+1), {disabled: currentPage===totalPages}));
    }

    function openItem(item){
      if ((item.type || "").toLowerCase().includes("—Å–µ—Ä—ñ–∞–ª")) {
        // –°–µ—Ä—ñ–∞–ª / –ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª
        if ((item.type || "") === "–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª") {
          location.href = "/multseries.html?title=" + encodeURIComponent(item.title);
        } else {
          location.href = "/series.html?title=" + encodeURIComponent(item.title);
        }
      } else {
        // –§—ñ–ª—å–º
        location.href = "/film.html?id=" + item.id;
      }
    }

    function renderCards(){
      grid.innerHTML = "";
      if (!allItems.length) {
        grid.innerHTML = `<p style="color:#aaa;text-align:center;width:100%;">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</p>`;
        pagEl.innerHTML = "";
        return;
      }

      const start = (currentPage-1) * perPage;
      const pageItems = allItems.slice(start, start + perPage);

      pageItems.forEach(item => {
        const card = document.createElement("div");
        card.className = "film-card";
        const poster = item.poster || "https://via.placeholder.com/200x280?text=No+Image";

        card.innerHTML = `
          <div style="position:relative;">
            <img src="${poster}" alt="${item.title || ''}">
            ${String(item.pro_access || "").toUpperCase() === "PRO"
              ? `<div class="badge-pro">PRO</div>` : ""}
          </div>
          <h3>${item.title || ""}</h3>
        `;
        card.onclick = () => openItem(item);
        grid.appendChild(card);
      });

      renderPagination(allItems.length);
    }

    async function loadCollection(){
      if (!window.supabaseClient) {
        subEl.textContent = "‚ùå Supabase –Ω–µ –ø—ñ–¥–∫–ª—é—á–∏–≤—Å—è (–ø–µ—Ä–µ–≤—ñ—Ä supabase-client.js)";
        return;
      }

      if (!name) {
        subEl.textContent = "‚ùå –ù–µ –ø–µ—Ä–µ–¥–∞–Ω–æ –Ω–∞–∑–≤—É –∑–±—ñ—Ä–∫–∏";
        return;
      }

      subEl.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";

      // 1) –±–µ—Ä–µ–º–æ —Å–ø–∏—Å–æ–∫ —Ñ—ñ–ª—å–º—ñ–≤/—Å–µ—Ä—ñ–∞–ª—ñ–≤ —Ü—ñ—î—ó –∑–±—ñ—Ä–∫–∏
      // ‚ö†Ô∏è –ø—ñ–¥–ª–∞—à—Ç—É–π –Ω–∞–∑–≤—É —Ç–∞–±–ª–∏—Ü—ñ/–ø–æ–ª—è –ø—ñ–¥ —Å–≤–æ—ó (—è–∫ —É —Ç–µ–±–µ —Ä–µ–∞–ª—å–Ω–æ –≤ Supabase)
      // –Ø –∑–∞–ª–∏—à–∏–ª–∞ –ª–æ–≥—ñ–∫—É: collections_table: name + items (ids –∞–±–æ titles)
      const { data, error } = await window.supabaseClient
        .from("collections")
        .select("*")
        .eq("name", name)
        .limit(1);

      if (error || !data || !data.length){
        subEl.textContent = "‚ùå –ó–±—ñ—Ä–∫—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ";
        console.error(error);
        return;
      }

      const col = data[0];
      subEl.textContent = col.description ? col.description : " ";

      // 2) –¢—É—Ç 2 –≤–∞—Ä—ñ–∞–Ω—Ç–∏. –¢–∏ –º–æ–∂–µ—à –∑–±–µ—Ä—ñ–≥–∞—Ç–∏:
      // A) –º–∞—Å–∏–≤ ID: col.items_ids
      // B) –º–∞—Å–∏–≤ –Ω–∞–∑–≤: col.items_titles
      // –Ø –∑—Ä–æ–±–∏–ª–∞ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–æ: —è–∫—â–æ —î items_ids ‚Äî —Ñ—ñ–ª—å—Ç—Ä—É—î–º–æ –ø–æ id, —ñ–Ω–∞–∫—à–µ –ø–æ title.
      const ids = Array.isArray(col.items_ids) ? col.items_ids : null;
      const titles = Array.isArray(col.items_titles) ? col.items_titles : null;

      let q = window.supabaseClient.from("films_site").select("id,title,poster,type,pro_access,genre,year,imdb");

      if (ids && ids.length) {
        q = q.in("id", ids);
      } else if (titles && titles.length) {
        q = q.in("title", titles);
      } else {
        // —è–∫—â–æ —É —Ç–µ–±–µ —ñ–Ω—à–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî –Ω–∞–ø–∏—à–∏, —ñ —è –ø—ñ–¥–∂–µ–Ω—É –∑–∞–ø–∏—Ç
        grid.innerHTML = `<p style="color:#aaa;text-align:center;">‚ö†Ô∏è –£ –∑–±—ñ—Ä—Ü—ñ –Ω–µ–º–∞—î items_ids –∞–±–æ items_titles</p>`;
        return;
      }

      const { data: items, error: err2 } = await q;
      if (err2 || !items){
        console.error(err2);
        grid.innerHTML = `<p style="color:#ff6b6b;text-align:center;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ñ—ñ–ª—å–º—ñ–≤</p>`;
        return;
      }

      // –°–æ—Ä—Ç—É—î–º–æ —è–∫ –ø—Ä–∏–π—à–ª–∏ (–∞–±–æ –∑–∞ imdb/—Ä–æ–∫–æ–º ‚Äî —Å–∫–∞–∂–µ—à)
      allItems = items;

      currentPage = 1;
      renderCards();
    }

    loadCollection();
  </script>

  <div id="footer-placeholder"></div>
  <script>
    fetch("footer.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("footer-placeholder").innerHTML = html;
        const s = document.createElement("script");
        s.src = "footer.js";
        document.body.appendChild(s);
      });
  </script>
</body>
</html>
