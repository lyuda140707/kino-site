<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª–∏ ‚Äî KinoSite</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    body {
      background-color: #0b0c0f;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 1100px;
      margin: 20px auto;
      padding: 10px;
    }

    h1 {
      text-align: center;
      color: #00fff2;
      margin-bottom: 10px;
    }

    .series-card {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .episode {
      background: #111;
      border: 1px solid rgba(0,255,255,0.2);
      border-radius: 10px;
      padding: 10px;
      width: 300px;
    }

    .episode img {
      width: 100%;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .episode p {
      margin: 5px 0;
    }

    .bookmark-btn {
      background-color: #00fff2;
      border: none;
      color: #111;
      font-weight: bold;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: .2s;
    }

    .bookmark-btn:hover {
      background-color: #00e0d0;
    }

    /* === ‚ö† –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –ø—Ä–æ –ø—Ä–æ–±–ª–µ–º—É === */
    .report-btn {
      background: transparent;
      border: 1px solid rgba(255,140,0,.6);
      color: #ffa500;
      font-size: 14px;
      font-weight: 700;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: .2s;
      margin-left: 8px;
    }

    .report-btn:hover {
      box-shadow: 0 0 12px rgba(255,140,0,.35);
      transform: scale(1.03);
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal {
      width: min(520px, 92vw);
      background: #121317;
      border: 1px solid #2a2d33;
      border-radius: 14px;
      padding: 14px;
    }

    .modal h3 {margin:0 0 8px; color:#ffa500}

    .modal textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      border-radius: 10px;
      border: 1px solid #333;
      background: #0f1014;
      color: #eee;
      padding: 10px;
    }

    .modal .row {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      justify-content: flex-end;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid #444;
      color: #ddd;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-send {
      background: #ffa500;
      color: #111;
      font-weight: 700;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="seriesTitle">–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª</h1>

    <div style="text-align:center;margin-bottom:10px;">
      <button id="bookmarkSeriesBtn" class="bookmark-btn">‚≠ê –î–æ–¥–∞—Ç–∏ –≤ –∑–∞–∫–ª–∞–¥–∫–∏</button>
      <button id="reportIssueBtn" class="report-btn">‚ö† –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –ø—Ä–æ –ø—Ä–æ–±–ª–µ–º—É</button>
    </div>

    <div class="series-card" id="episodesList"></div>
  </div>

  <!-- === ‚ö† –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –ø—Ä–æ –ø—Ä–æ–±–ª–µ–º—É (–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª–∏) === -->
  <div id="reportModal" class="modal-backdrop">
    <div class="modal">
      <h3>‚ö† –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –ø—Ä–æ –ø—Ä–æ–±–ª–µ–º—É</h3>
      <p style="color:#9aa0a6;margin:6px 0 10px">
        –û–ø–∏—à—ñ—Ç—å, —â–æ —Å–∞–º–µ –Ω–µ –ø—Ä–∞—Ü—é—î (–ø–æ—Å–∏–ª–∞–Ω–Ω—è, —Å–µ—Ä—ñ—è, –ø–ª–µ—î—Ä —Ç–æ—â–æ).
      </p>
      <textarea id="reportText" placeholder="–ö–æ—Ä–æ—Ç–∫–æ –æ–ø–∏—à—ñ—Ç—å –ø—Ä–æ–±–ª–µ–º—É..."></textarea>
      <div class="row">
        <button id="reportCancel" class="btn-ghost">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button id="reportSend" class="btn-send">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = "https://zerlqvbmqszomlondlte.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplcmxxdmJtcXN6b21sb25kbHRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzg3NzQsImV4cCI6MjA3MDkxNDc3NH0.8wUBYIeQRC6KVp6vdzv0oqofIf4PeZyzbV5GcD0vxTE";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    async function loadSeries(){
      const params = new URLSearchParams(window.location.search);
      const seriesTitle = params.get("title");
      const { data, error } = await supabase
        .from("films_site")
        .select("*")
        .ilike("type", "–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª")
        .ilike("title", `%${seriesTitle}%`)
        .order("season", { ascending: true })
        .order("episode", { ascending: true });

      if (error || !data?.length) {
        document.body.innerHTML = "<h2 style='color:#fff;text-align:center;margin-top:40px'>–°–µ—Ä—ñ–∞–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h2>";
        return;
      }

      const first = data[0];
      document.getElementById("seriesTitle").textContent = first.title;

      const container = document.getElementById("episodesList");
      container.innerHTML = "";

      data.forEach(ep => {
        const div = document.createElement("div");
        div.className = "episode";
        div.innerHTML = `
          <img src="${ep.poster || ''}" alt="${ep.title}">
          <p><b>–°–µ–∑–æ–Ω:</b> ${ep.season || '1'}</p>
          <p><b>–°–µ—Ä—ñ—è:</b> ${ep.episode || '‚Äî'}</p>
          <video src="${ep.stream_url || ''}" controls preload="metadata" style="width:100%;border-radius:10px;"></video>
        `;
        container.appendChild(div);
      });
    }

    document.addEventListener("DOMContentLoaded", loadSeries);
  </script>

  <script>
  // === ‚ö† –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –ø—Ä–æ –ø—Ä–æ–±–ª–µ–º—É (–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª–∏) ===
  (function(){
    const modal   = document.getElementById("reportModal");
    const txt     = document.getElementById("reportText");
    const btnOpen = document.getElementById("reportIssueBtn");
    const btnSend = document.getElementById("reportSend");
    const btnCancel = document.getElementById("reportCancel");

    if (!btnOpen || !modal) return;

    btnOpen.addEventListener("click", ()=>{ modal.style.display="flex"; txt.focus(); });
    btnCancel.addEventListener("click", ()=>{ modal.style.display="none"; txt.value=""; });
    modal.addEventListener("click", (e)=>{ if (e.target===modal) modal.style.display="none"; });

    async function sendReport(item_type, titleElId){
      const message = (txt.value || "").trim();
      if (message.length < 5) return alert("–û–ø–∏—à—ñ—Ç—å –ø—Ä–æ–±–ª–µ–º—É –¥–µ—Ç–∞–ª—å–Ω—ñ—à–µ (–º—ñ–Ω—ñ–º—É–º 5 —Å–∏–º–≤–æ–ª—ñ–≤).");

      const title = (document.getElementById(titleElId)?.textContent || "").trim();
      let user = null;
      try { user = JSON.parse(localStorage.getItem("telegram_user") || "null"); } catch {}

      const payload = {
        user_id: user?.id ? String(user.id) : null,
        user_name: [user?.first_name, user?.last_name].filter(Boolean).join(" ") || user?.username || null,
        item_type,
        item_title: title,
        page_url: location.href,
        content: message,
        status: "new"
      };

      const { error } = await supabase.from("feedback_reports").insert(payload);
      if (error) {
        console.error(error);
        alert("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥ —á–∞—Å –≤—ñ–¥–ø—Ä–∞–≤–∫–∏. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.");
        return;
      }

      modal.style.display="none";
      txt.value="";
      alert("‚úÖ –î—è–∫—É—î–º–æ! –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ. –í—ñ–¥–ø–æ–≤—ñ–¥—å –∑ º—è–≤–∏—Ç—å—Å—è —É —Ä–æ–∑–¥—ñ–ª—ñ ¬´–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è¬ª –≤–∞—à–æ–≥–æ –∫–∞–±—ñ–Ω–µ—Ç—É.");
    }

    // üîπ –¥–ª—è –º—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª—ñ–≤
    btnSend.onclick = ()=>sendReport("–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª", "seriesTitle");
  })();
  </script>
</body>
</html>
