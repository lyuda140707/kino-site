<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç ‚Äî KinoSite</title>

<!-- ‚úÖ –ë–µ–∑–ø–µ—á–Ω—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏ -->
<meta http-equiv="Content-Security-Policy"
      content="default-src * 'self' data: blob: https: http:;
               script-src 'self' 'unsafe-inline' 'unsafe-eval' https://telegram.org https://oauth.telegram.org https://cdn.jsdelivr.net;
               frame-src https://oauth.telegram.org https://kino-site.pages.dev;
               connect-src *;
               style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
               font-src https://fonts.gstatic.com;">

<link rel="stylesheet" href="style.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
  .profile-wrap{max-width:860px;margin:24px auto;padding:16px}
  .card{background:#0e0f13;border:1px solid #222;border-radius:16px;padding:20px;margin-bottom:16px}
  .muted{color:#9aa0a6;font-size:13px}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer}
  .btn-primary{background:#00ffd5;color:#000;font-weight:600}
  .btn-ghost{background:transparent;border:1px solid #444;color:#ddd}
  .input{width:100%;padding:10px 12px;border:1px solid #333;border-radius:10px;background:#111;color:#eee}
.profile-actions {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 16px;
}

.profile-actions .btn {
  width: 100%;
  font-weight: 600;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.profile-actions .btn:hover {
  transform: scale(1.03);
  box-shadow: 0 0 12px rgba(0, 255, 255, 0.4);
}
/* === ‚≠ê –°—ñ—Ç–∫–∞ –∑–∞–∫–ª–∞–¥–æ–∫ —É "–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç" === */
.bookmark-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
  justify-content: center;
  margin-top: 14px;
}
.bookmark-card {
  background: #0d0f14;
  border: 1px solid rgba(0,255,255,0.18);
  border-radius: 10px;
  width: 150px;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  overflow: hidden;
}
.bookmark-card:hover {
  transform: scale(1.05);
  box-shadow: 0 0 14px rgba(0,255,255,0.28);
}
.bookmark-card img {
  width: 100%;
  height: 210px;
  object-fit: cover;
}
.bookmark-card p {
  color: #fff;
  text-align: center;
  font-size: 13.5px;
  margin: 6px 8px 10px;
}

/* –≤–µ—Ä—Ö–Ω—ñ–π —Ä—è–¥–æ–∫ —Å–µ–∫—Ü—ñ—ó ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –∫–Ω–æ–ø–∫–∞ */
.fav-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  margin-top: 6px;
}
.fav-clear {
  background: transparent;
  border: 1px solid rgba(255, 77, 77, 0.4);
  color: #ff6b6b;
  border-radius: 8px;
  padding: 6px 10px;
  font-weight: 600;
  cursor: pointer;
}
.fav-clear:hover { box-shadow: 0 0 12px rgba(255, 77, 77, 0.35); }
/* === üì© –û–Ω–æ–≤–ª–µ–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ –∫–∞–±—ñ–Ω–µ—Ç—ñ === */
#messages-card {
  position: relative;
}

.message-item {
  background: #0f1117;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px;
  padding: 10px 12px;
  margin-bottom: 10px;
  position: relative;
}

.message-item.new::before {
  content: "‚Ä¢ –ù–æ–≤–µ";
  position: absolute;
  top: 6px;
  right: 10px;
  color: #00fff2;
  font-size: 12px;
  font-weight: 600;
}

.message-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.message-body {
  margin-top: 6px;
  color: #ddd;
  font-size: 14px;
  white-space: pre-wrap;
}

.msg-delete {
  background: transparent;
  border: 1px solid rgba(255,77,77,0.4);
  color: #ff6b6b;
  border-radius: 6px;
  padding: 3px 8px;
  font-size: 12px;
  cursor: pointer;
  transition: 0.2s;
}

.msg-delete:hover {
  background: rgba(255,77,77,0.15);
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.4; }
  100% { opacity: 1; }
}

</style>
</head>
<body>

<!-- –•–µ–¥–µ—Ä -->
<div id="header-placeholder"></div>
<script>
  fetch("header.html").then(r=>r.text()).then(html=>{
    document.getElementById("header-placeholder").innerHTML = html;
  });
// ===== –ö–Ω–æ–ø–∫–∏ —É –ø—Ä–æ—Ñ—ñ–ª—ñ
window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("get-pro")?.addEventListener("click", () => {
    window.location.href = "/pro.html";
  });

  document.getElementById("messages")?.addEventListener("click", () => {
    alert("üì© –†–æ–∑–¥—ñ–ª '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è' —É —Ä–æ–∑—Ä–æ–±—Ü—ñ");
  });

  document.getElementById("bookmarks")?.addEventListener("click", () => {
    const favSection = document.getElementById("favorites-card");
    if (favSection) {
      favSection.scrollIntoView({ behavior: "smooth", block: "start" });
    }
  });
});


      
</script>

<main class="profile-wrap">
  <h1>–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</h1>

  <!-- üß© –ë–ª–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ -->
  <div class="card" id="user-card" style="display:none;">
  <h3 id="hello-line">–í—ñ—Ç–∞—é!</h3>
  <p class="muted">–°—Ç–∞—Ç—É—Å: <span id="pro-status">‚Äî</span></p>
  <button class="btn btn-ghost" id="logout-btn">–í–∏–π—Ç–∏</button>

  <!-- üîπ –î–æ–¥–∞—Ç–∫–æ–≤—ñ –¥—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ -->
  <div class="profile-actions">
    <button id="get-pro" class="btn btn-primary">üíé –û—Ç—Ä–∏–º–∞—Ç–∏ PRO</button>
    

  </div>
</div>
<!-- ‚≠ê –ú–æ—ó –∑–∞–∫–ª–∞–¥–∫–∏ —É –∫–∞–±—ñ–Ω–µ—Ç—ñ -->
<div class="card" id="favorites-card">
  <div class="fav-head">
    <h3 style="margin:0;color:#00fff2;">‚≠ê –ú–æ—ó –∑–∞–∫–ª–∞–¥–∫–∏</h3>
    <button id="favClearBtn" class="fav-clear">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
  </div>
  <div id="favoritesList" class="bookmark-grid"></div>
</div>
<!-- üì© –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ü—ñ—ó -->
<div class="card" id="messages-card">
  <h3 style="margin:0 0 10px;color:#00fff2;">üì© –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h3>
  <div id="messagesList"></div>
</div>

  <!-- üì® –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è Email -->
  <div class="card" id="auth-card">
    <h3>–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Email</h3>
    <div style="display:flex;flex-direction:column;gap:8px;max-width:320px;">
      <input id="email-input" class="input" type="email" placeholder="email@example.com" />
      <button class="btn btn-primary" id="email-login-btn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –≤—Ö–æ–¥—É</button>
    </div>
  </div>

  <!-- ü§ñ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è Telegram -->
  <div class="card" id="telegram-card">
    <h3>–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</h3>
    <p class="muted">
      –Ø–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –Ω–∞—à Telegram-–±–æ—Ç, —Ü–µ–π —Å–ø–æ—Å—ñ–± –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î –≤–∞—à PRO-—Å—Ç–∞—Ç—É—Å.
    </p>

<div id="telegram-widget">
  <script async src="https://telegram.org/js/telegram-widget.js?22"
          data-telegram-login="RelaxBox_UA_bot"
          data-size="large"
          data-radius="8"
          data-userpic="true"
          data-request-access="write"
          data-onauth="onTelegramAuth(user)">
  </script>
</div>

  </div>
</main>

<footer style="text-align:center;color:#8a8f98;margin:32px 0">¬© 2025 KinoSite</footer>
<script>
// === ‚≠ê –ó–∞–∫–ª–∞–¥–∫–∏ –≤ –∫–∞–±—ñ–Ω–µ—Ç—ñ ===
function getLocalBookmarks() {
  try { return JSON.parse(localStorage.getItem("bookmarks") || "[]"); }
  catch { return []; }
}

function renderBookmarksInProfile() {
  const card = document.getElementById("favorites-card");
  const listEl = document.getElementById("favoritesList");
  if (!card || !listEl) return;

  const list = Array.isArray(getLocalBookmarks()) ? getLocalBookmarks() : [];
  listEl.innerHTML = "";

  if (!list.length) {
    listEl.innerHTML = "<p style='color:#9aa0a6;text-align:center;width:100%;margin:6px 0 2px;'>–ü–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—å–æ üïØÔ∏è</p>";
  } else {
    list.forEach(item => {
      const id = item?.id ?? "";
      const title = item?.title || "–ë–µ–∑ –Ω–∞–∑–≤–∏";
      const poster = item?.poster || "https://via.placeholder.com/150x210?text=No+Image";
      // üëá –Ü–Ω—Ç–µ–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ –≤–∏–∑–Ω–∞—á–∞—î–º–æ type, —è–∫—â–æ –π–æ–≥–æ –Ω–µ–º–∞
      const type = item?.type
        || (id ? "–§—ñ–ª—å–º" : "")                             // —è–∫—â–æ —î id ‚Äî –º–∞–π–∂–µ —Ç–æ—á–Ω–æ —Ñ—ñ–ª—å–º
        || (title?.toLowerCase().includes("–º—É–ª—å—Ç") ? "–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª" : "–°–µ—Ä—ñ–∞–ª"); // —ñ–Ω–∞–∫—à–µ —Å–µ—Ä—ñ–∞–ª/–º—É–ª—å—Ç

      // –ö—É–¥–∏ –≤–µ—Å—Ç–∏ –ø–æ –∫–ª—ñ–∫—É
      let href = `film.html?id=${encodeURIComponent(id)}`;
      if (type === "–°–µ—Ä—ñ–∞–ª") href = `series.html?title=${encodeURIComponent(title)}`;
      if (type === "–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª") href = `multseries.html?title=${encodeURIComponent(title)}`;

      const div = document.createElement("div");
      div.className = "bookmark-card";
      div.innerHTML = `
        <img src="${poster}" alt="${title}">
        <p>${title}</p>
      `;
      div.onclick = () => {
        // —è–∫—â–æ –≤–∏–ø–∞–¥–∫–æ–≤–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤—ñ–¥–∫—Ä–∏–≤–∞—î –±–µ–∑ .html ‚Äî –¥–æ–¥–∞—î–º–æ —ó—ó
        if (!href.endsWith(".html") && !href.includes(".html?")) {
          if (href.includes("series")) href = "series.html" + href.split("series")[1];
          else if (href.includes("multseries")) href = "multseries.html" + href.split("multseries")[1];
          else if (href.includes("film")) href = "film.html" + href.split("film")[1];
        }
        window.location.href = href;
      };

      listEl.appendChild(div);
    });
  }

  card.style.display = "block";
}

document.getElementById("favClearBtn")?.addEventListener("click", () => {
  if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∑–∞–∫–ª–∞–¥–∫–∏?")) return;
  localStorage.removeItem("bookmarks");
  renderBookmarksInProfile();
});

window.addEventListener("DOMContentLoaded", renderBookmarksInProfile);
renderBookmarksInProfile();
</script>


<!-- ‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = "https://zerlqvbmqszomlondlte.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplcmxxdmJtcXN6b21sb25kbHRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzg3NzQsImV4cCI6MjA3MDkxNDc3NH0.8wUBYIeQRC6KVp6vdzv0oqofIf4PeZyzbV5GcD0vxTE";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // ===== –í—Ö—ñ–¥ —á–µ—Ä–µ–∑ Email
  document.getElementById("email-login-btn").onclick = async () => {
    const email = document.getElementById("email-input").value.trim();
    if (!email) return alert("–í–≤–µ–¥—ñ—Ç—å email");
    const { error } = await supabase.auth.signInWithOtp({ email });
    alert(error ? "–ü–æ–º–∏–ª–∫–∞: " + error.message : "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ—à—Ç—É, —â–æ–± —É–≤—ñ–π—Ç–∏!");
  };

  // ===== –í–∏—Ö—ñ–¥
  document.getElementById("logout-btn").onclick = () => {
    localStorage.removeItem("telegram_user");
    location.reload();
  };

  // ===== –û—Å–Ω–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  async function handleTelegramUser(user) {
    document.getElementById("auth-card").style.display = "none";
    document.getElementById("telegram-card").style.display = "none";
    document.getElementById("user-card").style.display = "block";

    document.getElementById("hello-line").innerText = `–í—ñ—Ç–∞—é, ${user.first_name || ""} ${user.last_name || ""}`.trim();

    try {
      const res = await fetch(
        "https://script.google.com/macros/s/AKfycbyrCxL8N7w1XC3JDU-A1QMlZn8NKs5QKaS1vg-TRjijk_zI00i_y5KP-N5_VNjUA17xyA/exec?user_id=" +
          encodeURIComponent(user.id)
      );
      const json = await res.json();
      if (json.isPro) {
        const d = json.expireDate?.split("T")[0]?.split("-").reverse().join(".");
        document.getElementById("pro-status").innerHTML = `‚úÖ PRO –∞–∫—Ç–∏–≤–Ω–∏–π –¥–æ <b>${d}</b>`;
      } else {
        document.getElementById("pro-status").innerText = "‚ùå –ë–µ–∑ PRO";
      }
    } catch (err) {
      console.error(err);
      document.getElementById("pro-status").innerText = "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ PRO";
    }
      // ‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      loadMessagesForUser(user.id);
  }

  // ===== Telegram callback
  function onTelegramAuth(user) {
    console.log("‚úÖ Telegram –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:", user);
    localStorage.setItem("telegram_user", JSON.stringify(user)); // –∑–±–µ—Ä—ñ–≥–∞—î–º–æ
    handleTelegramUser(user);
  }

  // ===== –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
  window.addEventListener("DOMContentLoaded", () => {
    const savedUser = localStorage.getItem("telegram_user");
    if (savedUser) {
      try {
        const user = JSON.parse(savedUser);
        console.log("üîÑ –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ localStorage:", user);
        document.getElementById("telegram-card").style.display = "none";
        handleTelegramUser(user);
      } catch (e) {
        console.warn("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è —Ä–æ–∑–ø–∞—Ä—Å–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:", e);
      }
    }
  });
// === üì© –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ===
async function loadMessagesForUser(userId) {
  const box = document.getElementById("messagesList");
  if (!box) return;
  box.innerHTML = `<p class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>`;

  const { data, error } = await supabase
    .from("user_messages")
    .select("*")
    .eq("user_id", String(userId))
    .order("created_at", { ascending: false });

  if (error) {
    console.error(error);
    box.innerHTML = `<p class="muted">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</p>`;
    return;
  }

  if (!data?.length) {
    box.innerHTML = `<p class="muted">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</p>`;
    return;
  }

  const lastCount = Number(localStorage.getItem("last_msg_count") || 0);
  localStorage.setItem("last_msg_count", data.length);

  const isNew = data.length > lastCount;
  if (isNew) {
    const badge = document.createElement("div");
    badge.textContent = "üÜï –ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!";
    badge.style.cssText = `
      position:absolute;top:-8px;right:10px;
      color:#00fff2;font-size:13px;font-weight:600;
      animation:pulse 1.5s infinite;
    `;
    document.getElementById("messages-card").appendChild(badge);
  }

  box.innerHTML = "";
  data.forEach((m) => {
    const card = document.createElement("div");
    card.className = "message-item" + (isNew ? " new" : "");
    card.innerHTML = `
      <div class="message-header">
        <b>${m.title || "–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"}</b>
        <small style="color:#9aa0a6">${new Date(m.created_at).toLocaleString()}</small>
      </div>
      <div class="message-body">${m.body || ""}</div>
      ${m.from_name ? `<small style="color:#7bd9ff">‚Äî ${m.from_name}</small>` : ""}
      <button class="msg-delete">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
    `;
    card.querySelector(".msg-delete").addEventListener("click", async () => {
      if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?")) return;
      await supabase.from("user_messages").delete().eq("id", m.id);
      card.remove();
    });
    box.appendChild(card);
  });
}


</script>

</body>
</html>
