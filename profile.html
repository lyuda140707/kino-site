<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ PWA / Icons -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#00fff2">

  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png">

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes"><!-- ‚úÖ —â–æ–± –ø—Ä–∏–±—Ä–∞—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icon-512.png">

  <title>–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç ‚Äî KinoSite</title>

  <!-- ‚úÖ CSP —É meta (—è–∫ –∑–∞–ø–∞—Å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç)
       ‚ö†Ô∏è –Ø–∫—â–æ —É —Ç–µ–±–µ CSP –∑–∞–¥–∞–Ω–∏–π —É Cloudflare _headers ‚Äî –≤—ñ–Ω –ü–ï–†–ï–ë‚Äô–Ñ meta -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src * 'self' data: blob: https: http:;
                 script-src 'self' 'unsafe-inline' 'unsafe-eval' https://telegram.org https://oauth.telegram.org https://cdn.jsdelivr.net;
                 frame-src https://oauth.telegram.org https://kino-site.top;
                 connect-src *;
                 style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
                 font-src https://fonts.gstatic.com;">

  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    .pro-actions {display:flex;flex-direction:column;gap:8px;margin-top:12px;}
    .pro-actions .btn {background:transparent;border:1px solid rgba(0,255,255,0.3);color:#00fff2;}
    .pro-actions .btn:hover {background:rgba(0,255,255,0.1);}

    body {background:#0b0c10;color:#e6e6e6;font-family:"Poppins",sans-serif;margin:0;padding:0;}

    .profile-wrap {
      max-width: 1000px; margin: 40px auto; padding: 0 16px;
      display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px;
    }

    .card {
      background:#111318;border:1px solid rgba(0,255,255,0.08);border-radius:14px;
      box-shadow:0 0 10px rgba(0,255,255,0.05);padding:18px 20px;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .card:hover {transform: translateY(-2px); box-shadow:0 0 16px rgba(0,255,255,0.2);}

    h1 {grid-column:1 / -1;text-align:center;color:#00fff2;font-weight:600;font-size:26px;margin-bottom:4px;}
    h3 {color:#00fff2;margin-top:0;font-size:18px;}

    .btn {padding:9px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:600;transition:transform .2s ease, box-shadow .2s ease;}
    .btn-primary {background:linear-gradient(45deg,#00fff2,#4a00e0);color:#fff;}
    .btn-ghost {background:transparent;border:1px solid rgba(0,255,255,0.3);color:#00fff2;}
    .btn:hover {transform:scale(1.03);box-shadow:0 0 10px rgba(0,255,255,0.25);}

    #user-card {text-align:center;}
    #user-card h3 {font-size:20px;}
    #user-card .muted {color:#9aa0a6;font-size:13px;}
    .profile-actions {margin-top:10px;display:flex;flex-direction:column;gap:8px;}

    .bookmark-grid {display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:14px;margin-top:10px;}
    .bookmark-card {background:#0d0f14;border:1px solid rgba(0,255,255,0.15);border-radius:10px;overflow:hidden;cursor:pointer;transition:.2s;}
    .bookmark-card:hover {transform:scale(1.05);box-shadow:0 0 12px rgba(0,255,255,0.25);}
    .bookmark-card img {width:100%;height:190px;object-fit:cover;}
    .bookmark-card p {margin:8px;text-align:center;font-size:13.5px;color:#eaeaea;}

    .message-item {background:#0e1015;border:1px solid rgba(0,255,255,0.1);border-radius:10px;padding:10px 12px;margin-bottom:8px;}
    #messages-card {position:relative;}
    .message-header {display:flex;justify-content:space-between;align-items:center;}
    .message-body {margin-top:6px;color:#ddd;font-size:14px;}
    .msg-delete {background:transparent;border:1px solid rgba(255,77,77,0.4);color:#ff6b6b;border-radius:6px;padding:3px 8px;font-size:12px;cursor:pointer;}
    .msg-delete:hover {background:rgba(255,77,77,0.15);}

    .msg-btn-badge {
      position:absolute;top:-6px;right:-6px;background:linear-gradient(45deg,#00fff2,#4a00e0);color:#fff;border-radius:50%;
      width:18px;height:18px;font-size:11px;font-weight:600;display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 8px rgba(0,255,255,0.4);animation:pulseBadge 1.5s infinite;
    }
    @keyframes pulseBadge {0%{transform:scale(1);opacity:1;}50%{transform:scale(1.2);opacity:.7;}100%{transform:scale(1);opacity:1;}}

    /* Modal */
    .modal {display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;}
    .modal-content {
      background:#111318;border:1px solid rgba(0,255,255,0.2);border-radius:14px;padding:24px;max-width:400px;color:#e6e6e6;
      text-align:center;box-shadow:0 0 25px rgba(0,255,255,0.3);animation:fadeIn .3s ease;
    }
    .modal-actions {display:flex;justify-content:center;gap:10px;margin-top:20px;}
    @keyframes fadeIn {from{transform:scale(.9);opacity:0;}to{transform:scale(1);opacity:1;}}

    .pro-actions #btn-paid-tg, .pro-actions #btn-paid-web {display:none;}
  </style>
</head>

<body>
  <div id="header-placeholder"></div>
  <script>
    // ‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ header.html —ñ –∞–∫—Ç–∏–≤—É—î–º–æ –ø–æ—à—É–∫ –ø—ñ—Å–ª—è –≤—Å—Ç–∞–≤–∫–∏
    function bindHeaderSearch() {
      const input = document.getElementById("search-input");
      if (!input) return;
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const query = input.value.trim();
          if (query.length > 1) {
            localStorage.setItem("searchQuery", query);
            window.location.href = "/search.html";
          }
        }
      });
    }

    fetch("header.html")
      .then(r => r.text())
      .then(html => { document.getElementById("header-placeholder").innerHTML = html; bindHeaderSearch(); })
      .catch(err => console.error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Ö–µ–¥–µ—Ä–∞:", err));
  </script>

  <main class="profile-wrap">
    <h1>–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</h1>

    <!-- üß© –ë–ª–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ -->
    <div class="card" id="user-card" style="display:none;">
      <h3 id="hello-line">–í—ñ—Ç–∞—é!</h3>
      <p id="auth-type" class="muted"></p>
      <p class="muted">–°—Ç–∞—Ç—É—Å: <span id="pro-status">‚Äî</span></p>
      <button class="btn btn-ghost" id="logout-btn">–í–∏–π—Ç–∏</button>

      <div class="profile-actions">
        <button id="messages" class="btn btn-ghost">üì© –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</button>
      </div>

      <div class="pro-actions" style="margin-top:14px;">
        <div id="pro-status-text" class="muted">–ü–µ—Ä–µ–≤—ñ—Ä—è—é —Å—Ç–∞—Ç—É—Å...</div>
        <button id="get-pro" class="btn btn-primary">üíé –û—Ç—Ä–∏–º–∞—Ç–∏ PRO</button>

        <button id="btn-paid-tg" class="btn btn-ghost" style="display:none;">
          ‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–≤(–ª–∞) ‚Äî —á–µ—Ä–µ–∑ Telegram
        </button>
        <button id="btn-paid-web" class="btn btn-ghost" style="display:none;">
          ‚úÖ –Ø –æ–ø–ª–∞—Ç–∏–≤(–ª–∞) ‚Äî –±–µ–∑ Telegram
        </button>
      </div>
    </div>

    <!-- ‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø–µ—Ä–µ–≥–ª—è–¥ -->
    <div class="card" id="continue-watch-card" style="position:relative;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h3 style="margin:0;color:#00fff2;display:flex;align-items:center;gap:8px;">
          <span style="font-size:20px;">‚ñ∂Ô∏è</span> –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø–µ—Ä–µ–≥–ª—è–¥
        </h3>
        <button id="clearLastWatch" style="background:transparent;border:none;color:#888;font-size:13px;cursor:pointer;transition:color .2s;">
          üóë –û—á–∏—Å—Ç–∏—Ç–∏
        </button>
      </div>
      <div id="continue-watch-grid" class="bookmark-grid"></div>
    </div>

    <!-- ‚≠ê –ú–æ—ó –∑–∞–∫–ª–∞–¥–∫–∏ -->
    <div class="card" id="favorites-card">
      <div class="fav-head">
        <h3 style="margin:0;color:#00fff2;">‚≠ê –ú–æ—ó –∑–∞–∫–ª–∞–¥–∫–∏</h3>
        <button id="favClearBtn" class="fav-clear">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
      </div>
      <div id="favoritesList" class="bookmark-grid"></div>
    </div>

    <!-- üì© –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
    <div class="card" id="messages-card" style="display:none;">
      <h3 style="margin:0 0 10px;color:#00fff2;">üì© –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h3>
      <div id="messagesList"></div>
    </div>

    <!-- üì® –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è Email -->
    <div class="card" id="auth-card">
      <h3>–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Email</h3>
      <div style="display:flex;flex-direction:column;gap:8px;max-width:320px;">
        <input id="email-input" class="input" type="email" placeholder="email@example.com" />
        <button class="btn btn-primary" id="email-login-btn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –¥–ª—è –≤—Ö–æ–¥—É</button>
      </div>
    </div>

    <!-- ü§ñ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è Telegram -->
    <div class="card" id="telegram-card">
      <h3>–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</h3>
      <p class="muted">
        –Ø–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –Ω–∞—à Telegram-–±–æ—Ç, —Ü–µ–π —Å–ø–æ—Å—ñ–± –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î –≤–∞—à PRO-—Å—Ç–∞—Ç—É—Å.
      </p>

      <script>
        // ‚úÖ —Ü—è —Ñ—É–Ω–∫—Ü—ñ—è –º–∞—î –±—É—Ç–∏ –î–û –≤—ñ–¥–∂–µ—Ç–∞
        function onTelegramAuth(user) {
          console.log("‚úÖ Telegram –∞–≤—Ç–æ—Ä–∏–∑—É–≤–∞–≤:", user);
          if (!user?.id) return console.warn("‚ùå –ù–µ–º–∞—î user.id");

          try {
            localStorage.setItem("telegram_user", JSON.stringify(user));
            localStorage.setItem("auth_time", Date.now());

            const msg = document.getElementById("login-message");
            if (msg) {
              msg.style.display = "block";
              msg.style.opacity = "1";
              setTimeout(() => { msg.style.opacity = "0"; }, 1500);
            }
            setTimeout(() => window.location.reload(), 1800);
          } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è Telegram –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:", e);
          }
        }
      </script>

      <div id="telegram-widget">
        <script async src="https://telegram.org/js/telegram-widget.js?22"
          data-telegram-login="RelaxBoxUA_bot"
          data-size="large"
          data-userpic="false"
          data-request-access="write"
          data-onauth="onTelegramAuth(user)">
        </script>
      </div>
    </div>
  </main>

  <footer style="text-align:center;color:#8a8f98;margin:32px 0">¬© 2025 KinoSite</footer>

  <script>
    // ===== –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –ø–µ—Ä–µ–≥–ª—è–¥
    function renderContinueWatchingInProfile() {
      const grid = document.getElementById("continue-watch-grid");
      const data = JSON.parse(localStorage.getItem("lastWatched") || "null");
      if (!grid) return;

      if (!data) {
        grid.innerHTML = "<p style='color:#9aa0a6;text-align:center;width:100%;margin:6px 0 2px;'>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏—Ö üéûÔ∏è</p>";
        return;
      }

      const time = Math.floor((data.time || 0) / 60);
      const typeIcon = data.type === "–°–µ—Ä—ñ–∞–ª" ? "üì∫" : data.type === "–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª" ? "üß∏" : "üé¨";

      grid.innerHTML = `
        <div class="bookmark-card" onclick="window.location.href='${data.url || `film.html?id=${encodeURIComponent(data.id || "")}`}'">
          <img src="${data.poster || "https://via.placeholder.com/300x450?text=No+Image"}" alt="${(data.title||"").replaceAll('"','&quot;')}">
          <p>${typeIcon} ${data.title || "–ë–µ–∑ –Ω–∞–∑–≤–∏"}</p>
          <small style="color:#9aa0a6;display:block;text-align:center;margin-bottom:6px;">
            –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –∑ ${time} —Ö–≤
          </small>
        </div>
      `;
    }

    document.getElementById("clearLastWatch")?.addEventListener("click", () => {
      if (!confirm("–û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –ø–µ—Ä–µ–≥–ª—è–¥—É?")) return;
      localStorage.removeItem("lastWatched");
      renderContinueWatchingInProfile();
    });

    window.addEventListener("DOMContentLoaded", renderContinueWatchingInProfile);
  </script>

  <script>
    // ===== –ó–∞–∫–ª–∞–¥–∫–∏
    function getLocalBookmarks() {
      try { return JSON.parse(localStorage.getItem("bookmarks") || "[]"); }
      catch { return []; }
    }

    function renderBookmarksInProfile() {
      const card = document.getElementById("favorites-card");
      const listEl = document.getElementById("favoritesList");
      if (!card || !listEl) return;

      const list = Array.isArray(getLocalBookmarks()) ? getLocalBookmarks() : [];
      listEl.innerHTML = "";

      if (!list.length) {
        listEl.innerHTML = "<p style='color:#9aa0a6;text-align:center;width:100%;margin:6px 0 2px;'>–ü–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—å–æ üïØÔ∏è</p>";
      } else {
        list.forEach(item => {
          const id = item?.id ?? "";
          const title = item?.title || "–ë–µ–∑ –Ω–∞–∑–≤–∏";
          const poster = item?.poster || "https://via.placeholder.com/300x450?text=No+Image";
          const type = item?.type || (title?.toLowerCase().includes("–º—É–ª—å—Ç") ? "–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª" : "–§—ñ–ª—å–º");

          let href = `film.html?id=${encodeURIComponent(id)}`;
          if (type === "–°–µ—Ä—ñ–∞–ª") href = `series.html?title=${encodeURIComponent(title)}`;
          if (type === "–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª") href = `multseries.html?title=${encodeURIComponent(title)}`;

          const div = document.createElement("div");
          div.className = "bookmark-card";
          div.innerHTML = `<img src="${poster}" alt="${title}"><p>${title}</p>`;
          div.onclick = () => window.location.href = href;
          listEl.appendChild(div);
        });
      }

      card.style.display = "block";
    }

    document.getElementById("favClearBtn")?.addEventListener("click", () => {
      if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∑–∞–∫–ª–∞–¥–∫–∏?")) return;
      localStorage.removeItem("bookmarks");
      renderBookmarksInProfile();
    });

    window.addEventListener("DOMContentLoaded", renderBookmarksInProfile);
  </script>

  <!-- ‚úÖ Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ‚úÖ –í–ê–ñ–õ–ò–í–û: —Ç—É—Ç –±—É–ª–æ const supabase = ... -> —Ç–µ–ø–µ—Ä supabaseClient (—â–æ–± –Ω–µ –±—É–ª–æ already declared)
    const supabaseUrl = "https://zerlqvbmqszomlondlte.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplcmxxdmJtcXN6b21sb25kbHRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzg3NzQsImV4cCI6MjA3MDkxNDc3NH0.8wUBYIeQRC6KVp6vdzv0oqofIf4PeZyzbV5GcD0vxTE";
    const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

    // ‚úÖ Apps Script (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ PRO) ‚Äî –æ–≥–æ–ª–æ—à—É—î–º–æ –†–ê–ù–û, —â–æ–± –Ω–µ –±—É–ª–æ undefined
    window.APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzUl7EZMk9KlBUgirrZtCg6sK9POdlrqKVSuJt0NqQ1NHJWj2_-EX_gLLvN0DoykM0qsQ/exec";

    // ‚úÖ backend –¥–ª—è notify-payment
    const BACKEND_URL = "https://script.google.com/macros/s/AKfycbxW2_rhnZ2Q8a7BQJJA89Ij_65tKSmf6gr8XmOIE9Au0i_BQVv_6PS0xx5sWgKYQ16J/exec";

    // ===== Email login
    document.getElementById("email-login-btn").onclick = async () => {
      const email = document.getElementById("email-input").value.trim();
      if (!email) return alert("–í–≤–µ–¥—ñ—Ç—å email");
      const { error } = await supabaseClient.auth.signInWithOtp({ email });
      alert(error ? "–ü–æ–º–∏–ª–∫–∞: " + error.message : "–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø–æ—à—Ç—É, —â–æ–± —É–≤—ñ–π—Ç–∏!");
    };

    // ===== Web ID
    function getWebId() {
      let webId = localStorage.getItem("web_id");
      if (!webId) {
        const base = btoa(navigator.userAgent + navigator.language + "kino-site");
        webId = "WEB-" + base.slice(0, 12);
        localStorage.setItem("web_id", webId);
      }
      return webId;
    }

    // ===== UI helpers
    function updateProUI() {
      const btnTg = document.getElementById("btn-paid-tg");
      const btnWeb = document.getElementById("btn-paid-web");
      const getProBtn = document.getElementById("get-pro");
      const statusEl = document.getElementById("pro-status-text");

      if (!btnTg || !btnWeb || !getProBtn || !statusEl) return;

      btnTg.style.display = "none";
      btnWeb.style.display = "none";
      getProBtn.style.display = "inline-block";

      if (statusEl.innerText.includes("üíé PRO –∞–∫—Ç–∏–≤–Ω–∏–π")) {
        getProBtn.style.display = "none";
        return;
      }

      if (localStorage.getItem("pro_payment_started") === "true") {
        const hasTg = !!localStorage.getItem("telegram_user");
        const hasEmail = !!localStorage.getItem("email_user");

        if (hasTg) btnTg.style.display = "inline-block";
        else if (hasEmail) btnWeb.style.display = "inline-block";
        else btnWeb.style.display = "inline-block";

        getProBtn.style.display = "none";
      }
    }

    function showProStatus(data) {
      const statusEl = document.getElementById("pro-status-text");
      const proLabel = document.getElementById("pro-status");
      if (!statusEl) return;

      if (data?.ok && data?.isPro) {
        const d = data?.expireDate || "–Ω–µ–≤—ñ–¥–æ–º–æ";
        statusEl.innerHTML = `üíé PRO –∞–∫—Ç–∏–≤–Ω–∏–π –¥–æ <b>${d}</b>`;
        if (proLabel) proLabel.innerHTML = `‚úÖ PRO –∞–∫—Ç–∏–≤–Ω–∏–π –¥–æ <b>${d}</b>`;
        localStorage.removeItem("pro_payment_started");
      } else {
        statusEl.innerText = "üîí –ë–µ–∑ PRO";
        if (proLabel) proLabel.innerText = "‚ùå –ë–µ–∑ PRO";
      }
      updateProUI();
    }

    // ===== PRO status check
    async function checkProStatus() {
      const tgUserRaw = localStorage.getItem("telegram_user");
      const emailUserRaw = localStorage.getItem("email_user");

      let idParam = "";
      let paramType = "user_id";

      if (tgUserRaw) {
        try { idParam = JSON.parse(tgUserRaw).id; } catch {}
        paramType = "user_id";
      } else if (emailUserRaw) {
        idParam = getWebId();
        paramType = "user_id";
      } else {
        idParam = getWebId();
        paramType = "web_id";
      }

      const statusEl = document.getElementById("pro-status-text");
      if (!idParam) {
        if (statusEl) statusEl.innerText = "üîí –ë–µ–∑ PRO";
        return;
      }
      if (statusEl) statusEl.innerText = "‚è≥ –ü–µ—Ä–µ–≤—ñ—Ä—è—é —Å—Ç–∞—Ç—É—Å...";

      try {
        const url = `${window.APPS_SCRIPT_URL}?${paramType}=${encodeURIComponent(idParam)}`;
        const res = await fetch(url);
        const data = await res.json();
        localStorage.setItem("pro_cache", JSON.stringify({ id: idParam, data, time: Date.now() }));
        showProStatus(data);
      } catch (err) {
        console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ PRO:", err);
        if (statusEl) statusEl.innerText = "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏";
      }
    }

    // ===== Messages
    async function loadMessagesForUser(userId) {
      const box = document.getElementById("messagesList");
      if (!box) return;

      box.innerHTML = `<p class="muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>`;

      const { data, error } = await supabaseClient
        .from("user_messages")
        .select("*")
        .eq("user_id", String(userId))
        .order("created_at", { ascending: false });

      if (error) {
        console.error(error);
        box.innerHTML = `<p class="muted">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</p>`;
        return;
      }

      if (!data?.length) {
        box.innerHTML = `<p class="muted">–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</p>`;
        return;
      }

      const lastCount = Number(localStorage.getItem("last_msg_count") || 0);
      localStorage.setItem("last_msg_count", data.length);

      const isNew = data.length > lastCount;
      const msgBtn = document.getElementById("messages");
      const msgCard = document.getElementById("messages-card");

      if (isNew && msgBtn) {
        msgBtn.style.position = "relative";
        if (!msgBtn.querySelector(".msg-btn-badge")) {
          const btnBadge = document.createElement("div");
          btnBadge.className = "msg-btn-badge";
          btnBadge.textContent = data.length;
          msgBtn.appendChild(btnBadge);
        }
      }

      if (msgBtn && msgCard && !msgBtn.dataset.bound) {
        msgBtn.dataset.bound = "1";
        msgBtn.addEventListener("click", () => {
          const isVisible = msgCard.style.display === "block";
          msgCard.style.display = isVisible ? "none" : "block";
          if (!isVisible) {
            const badge = msgBtn.querySelector(".msg-btn-badge");
            if (badge) badge.remove();
          }
        });
      }

      box.innerHTML = "";
      data.forEach((m) => {
        const card = document.createElement("div");
        card.className = "message-item";
        card.innerHTML = `
          <div class="message-header">
            <b>${m.title || "–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"}</b>
            <small style="color:#9aa0a6">${new Date(m.created_at).toLocaleString()}</small>
          </div>
          <div class="message-body">${m.body || ""}</div>
          ${m.from_name ? `<small style="color:#7bd9ff">‚Äî ${m.from_name}</small>` : ""}
          <button class="msg-delete">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>
        `;
        card.querySelector(".msg-delete").addEventListener("click", async () => {
          if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?")) return;
          await supabaseClient.from("user_messages").delete().eq("id", m.id);
          card.remove();
        });
        box.appendChild(card);
      });
    }

    // ===== Telegram restore / profile show
    async function handleTelegramUser(user) {
      document.getElementById("auth-card").style.display = "none";
      document.getElementById("telegram-card").style.display = "none";
      document.getElementById("user-card").style.display = "block";

      document.getElementById("hello-line").innerText =
        `–í—ñ—Ç–∞—é, ${user.first_name || ""} ${user.last_name || ""}`.trim();
      const typeLine = document.getElementById("auth-type");
      if (typeLine) typeLine.innerText = "ü§ñ –í—Ö—ñ–¥ —á–µ—Ä–µ–∑ Telegram";

      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ PRO
      await checkProStatus();

      // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      loadMessagesForUser(user.id);
    }

    // ===== Logout
    document.getElementById("logout-btn").onclick = async () => {
      try { await supabaseClient.auth.signOut(); } catch(e) { console.warn(e); }
      localStorage.removeItem("telegram_user");
      localStorage.removeItem("email_user");
      localStorage.removeItem("pro_payment_started");
      location.reload();
    };

    // ===== Notify payment
    function getTgId() {
      const u = localStorage.getItem("telegram_user");
      try { return u ? JSON.parse(u).id : null; } catch { return null; }
    }

    async function notifyPaymentTG() {
      const tg_id = getTgId();
      if (!tg_id) return alert("–°–ø–æ—á–∞—Ç–∫—É –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—è —á–µ—Ä–µ–∑ Telegram!");
      try {
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: tg_id, source: "site" })
        });
        if (!res.ok) throw new Error("notify-payment failed");
        alert("‚úÖ –ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º—ñ–Ω—É. –ü—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è PRO –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è.");
      } catch (e) {
        console.error(e);
        alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–ø–∏—Ç. –ù–∞–ø–∏—à—ñ—Ç—å –∞–¥–º—ñ–Ω—É.");
      }
    }

    async function notifyPaymentWEB() {
      const web_id = getWebId();
      try {
        const res = await fetch(BACKEND_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ web_id, source: "site" })
        });
        if (!res.ok) throw new Error("notify-payment failed");
        alert("‚úÖ –ó–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º—ñ–Ω—É.\n–ü—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è PRO –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è.\n–í–∞—à WEB-ID: " + web_id);
      } catch (e) {
        console.error(e);
        alert("‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–ø–∏—Ç. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.");
      }
    }

    // ===== Modal –æ–ø–ª–∞—Ç
    function initProModal() {
      const modal = document.getElementById("proModal");
      const btnGetPro = document.getElementById("get-pro");
      const btnConfirmPay = document.getElementById("confirmPay");
      const btnClose = document.getElementById("closeModal");

      if (!modal || !btnGetPro || !btnConfirmPay || !btnClose) return;

      btnGetPro.addEventListener("click", () => {
        const hasTg = !!localStorage.getItem("telegram_user");
        const hasEmail = !!localStorage.getItem("email_user");
        if (!hasTg && !hasEmail) {
          alert("‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É —É–≤—ñ–π–¥—ñ—Ç—å —á–µ—Ä–µ–∑ Telegram –∞–±–æ Email, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ PRO.");
          return;
        }
        modal.style.display = "flex";
      });

      btnClose.addEventListener("click", () => modal.style.display = "none");

      btnConfirmPay.addEventListener("click", () => {
        modal.style.display = "none";
        localStorage.setItem("pro_payment_started", "true");
        updateProUI();

        const monoUrl = "https://send.monobank.ua/jar/8FbfB4fY6S";
        window.open(monoUrl, "_blank");
        alert("üí≥ –û–ø–ª–∞—Ç–∞ –≤—ñ–¥–∫—Ä–∏–ª–∞—Å—å —É –Ω–æ–≤—ñ–π –≤–∫–ª–∞–¥—Ü—ñ.\n–ü—ñ—Å–ª—è –ø–µ—Ä–µ–∫–∞–∑—É –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å ¬´–Ø –æ–ø–ª–∞—Ç–∏–≤(–ª–∞)¬ª!");
      });

      window.addEventListener("click", (e) => { if (e.target === modal) modal.style.display = "none"; });
    }

    // ===== Start
    window.addEventListener("DOMContentLoaded", async () => {
      // Email: —è–∫—â–æ –≤–∂–µ –∑–∞–π—à–æ–≤ –ø–æ magic link
      const { data } = await supabaseClient.auth.getUser();
      const user = data?.user || null;

      if (user) {
        localStorage.setItem("email_user", JSON.stringify({ id: user.id, email: user.email }));
        document.getElementById("auth-card").style.display = "none";
        document.getElementById("telegram-card").style.display = "none";
        document.getElementById("user-card").style.display = "block";
        document.getElementById("hello-line").innerText = `–í—ñ—Ç–∞—é, ${user.email}`;
        document.getElementById("auth-type").innerText = "üîë –í—Ö—ñ–¥ —á–µ—Ä–µ–∑ Email";
      }

      // –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è Telegram
      const savedTg = localStorage.getItem("telegram_user");
      if (savedTg) {
        try { await handleTelegramUser(JSON.parse(savedTg)); } catch (e) { console.warn(e); }
      }

      // –ö–Ω–æ–ø–∫–∏ "–Ø –æ–ø–ª–∞—Ç–∏–≤"
      document.getElementById("btn-paid-tg")?.addEventListener("click", notifyPaymentTG);
      document.getElementById("btn-paid-web")?.addEventListener("click", notifyPaymentWEB);

      // PRO —Å—Ç–∞—Ç—É—Å + UI
      await checkProStatus();
      updateProUI();

      // Modal init
      initProModal();

      // Service Worker (–±–µ–∑ sw-register.js)
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js").catch(() => {});
      }
    });
  </script>

  <!-- === üí¨ –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –ü–†–û –û–ü–õ–ê–¢–£ === -->
  <div id="proModal" class="modal">
    <div class="modal-content">
      <h3>üíé –û—Ç—Ä–∏–º–∞—Ç–∏ PRO –¥–æ—Å—Ç—É–ø</h3>
      <p>
        –ü—ñ—Å–ª—è –æ–ø–ª–∞—Ç–∏ —á–µ—Ä–µ–∑ Monobank –æ–±–æ–≤ º—è–∑–∫–æ–≤–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É
        <b style="color:#ff4bf2; text-shadow:0 0 6px rgba(255,75,242,0.6);">¬´–Ø –æ–ø–ª–∞—Ç–∏–≤(–ª–∞)¬ª</b>,
        —â–æ–± –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ –≤–∞—à PRO.
      </p>
      <div class="modal-actions">
        <button id="confirmPay" class="btn btn-primary">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –æ–ø–ª–∞—Ç–∏ üí≥</button>
        <button id="closeModal" class="btn btn-ghost">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <!-- üîπ –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é -->
  <div id="login-message" style="
    display:none; position:fixed; top:20px; left:50%; transform:translateX(-50%);
    background:linear-gradient(145deg,#00fff2,#00b5b0); color:#000; font-weight:600;
    padding:12px 24px; border-radius:12px; box-shadow:0 0 20px rgba(0,255,255,0.5);
    z-index:9999; transition:opacity .4s ease;">
    ‚úÖ –£—Å–ø—ñ—à–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ Telegram!
  </div>

  <script src="seo.js"></script>

  <div id="footer-placeholder"></div>
  <script>
    fetch("footer.html")
      .then(res => res.text())
      .then(html => {
        document.getElementById("footer-placeholder").innerHTML = html;
        const s = document.createElement("script");
        s.src = "footer.js";
        document.body.appendChild(s);
      });
  </script>
</body>
</html>
