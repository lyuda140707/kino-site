<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç ‚Äî KinoSite</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
body {
  font-family: 'Inter', sans-serif;
  background: #f6f6f8;
  margin: 0;
  color: #111;
}

/* –û—Å–Ω–æ–≤–Ω–∞ –±—ñ–ª–∞ –ø–∞–Ω–µ–ª—å */
.profile-wrap {
  max-width: 600px;
  margin: 40px auto;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  padding: 20px;
}

h1 {
  text-align: center;
  margin-top: 0;
  color: #111;
}

/* –ö–∞—Ä—Ç–∫–∏ */
.card {
  background: #fff;
  border: 1px solid #e3e3e3;
  border-radius: 12px;
  padding: 14px 16px;
  margin-bottom: 14px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.card h3 {
  margin-top: 0;
  margin-bottom: 6px;
  color: #5c4bff;
}

.btn {
  border: none;
  cursor: pointer;
  border-radius: 8px;
  padding: 8px 14px;
  font-weight: 600;
}

.btn-primary {
  background: linear-gradient(90deg, #6a5af9, #00bcd4);
  color: #fff;
}

.btn-ghost {
  background: transparent;
  border: 1px solid #ccc;
  color: #333;
}

/* –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è */
.message-item {
  background: #fafafa;
  border: 1px solid #ddd;
  border-radius: 10px;
  padding: 10px 12px;
  margin-bottom: 10px;
  position: relative;
}

.message-item.new::before {
  content: "üÜï –ù–æ–≤–µ";
  position: absolute;
  top: 6px;
  right: 10px;
  color: #00bcd4;
  font-size: 12px;
  animation: pulse 1.5s infinite;
}

.message-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.msg-delete {
  background: transparent;
  border: 1px solid #ff7b7b;
  color: #ff4d4d;
  border-radius: 6px;
  padding: 3px 8px;
  font-size: 12px;
  cursor: pointer;
}
.msg-delete:hover {
  background: rgba(255,77,77,0.1);
}

/* –ó–∞–∫–ª–∞–¥–∫–∏ */
.bookmark-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-top: 8px;
}
.bookmark-card {
  width: 120px;
  border: 1px solid #ddd;
  border-radius: 10px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  background: #fff;
}
.bookmark-card:hover {
  transform: scale(1.04);
  box-shadow: 0 0 12px rgba(0,0,0,0.1);
}
.bookmark-card img {
  width: 100%;
  height: 160px;
  object-fit: cover;
}
.bookmark-card p {
  color: #333;
  text-align: center;
  font-size: 13px;
  margin: 6px;
}

/* –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ */
.fav-clear {
  background: transparent;
  border: 1px solid rgba(255, 77, 77, 0.4);
  color: #ff4d4d;
  border-radius: 8px;
  padding: 4px 8px;
  font-size: 13px;
  cursor: pointer;
}
.fav-clear:hover {
  background: rgba(255, 77, 77, 0.08);
}

@keyframes pulse {
  0% {opacity: 1;}
  50% {opacity: 0.3;}
  100% {opacity: 1;}
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
@media (max-width: 600px) {
  .profile-wrap { margin: 20px 10px; padding: 16px; }
  .bookmark-card { width: 45%; }
}
</style>
</head>
<body>

<main class="profile-wrap">
  <h1>–ú—ñ–π –∫–∞–±—ñ–Ω–µ—Ç</h1>

  <!-- üß© –ë–ª–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ -->
  <div class="card" id="user-card" style="display:none;">
    <h3 id="hello-line">–í—ñ—Ç–∞—é!</h3>
    <p>–°—Ç–∞—Ç—É—Å: <span id="pro-status">‚Äî</span></p>
    <button class="btn btn-ghost" id="logout-btn">–í–∏–π—Ç–∏</button>
    <div style="margin-top:10px;">
      <button id="get-pro" class="btn btn-primary">üíé –û—Ç—Ä–∏–º–∞—Ç–∏ PRO</button>
    </div>
  </div>

  <!-- üì© –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
  <div class="card" id="messages-card">
    <h3>üì© –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</h3>
    <div id="messagesList"></div>
  </div>

  <!-- ‚≠ê –ú–æ—ó –∑–∞–∫–ª–∞–¥–∫–∏ -->
  <div class="card" id="favorites-card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>‚≠ê –ú–æ—ó –∑–∞–∫–ª–∞–¥–∫–∏</h3>
      <button id="favClearBtn" class="fav-clear">üóë –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
    </div>
    <div id="favoritesList" class="bookmark-grid"></div>
  </div>

  <!-- ü§ñ Telegram -->
  <div class="card" id="telegram-card">
    <h3>–£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Telegram</h3>
    <p style="font-size:14px;color:#555;">
      –Ø–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –Ω–∞—à Telegram-–±–æ—Ç, —Ü–µ–π —Å–ø–æ—Å—ñ–± –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î –≤–∞—à PRO-—Å—Ç–∞—Ç—É—Å.
    </p>
    <div id="telegram-widget">
      <script async src="https://telegram.org/js/telegram-widget.js?22"
              data-telegram-login="RelaxBox_UA_bot"
              data-size="large"
              data-radius="8"
              data-userpic="true"
              data-request-access="write"
              data-onauth="onTelegramAuth(user)">
      </script>
    </div>
  </div>
</main>

<footer style="text-align:center;color:#777;margin:30px 0;font-size:13px;">¬© 2025 KinoSite</footer>

<!-- ===== JS –ª–æ–≥—ñ–∫–∞ ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const supabaseUrl = "https://zerlqvbmqszomlondlte.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InplcmxxdmJtcXN6b21sb25kbHRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMzg3NzQsImV4cCI6MjA3MDkxNDc3NH0.8wUBYIeQRC6KVp6vdzv0oqofIf4PeZyzbV5GcD0vxTE";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// –í–∏—Ö—ñ–¥
document.getElementById("logout-btn").onclick = () => {
  localStorage.removeItem("telegram_user");
  location.reload();
};

// === Telegram –ª–æ–≥—ñ–∫–∞ (–Ω—ñ—á–æ–≥–æ –Ω–µ —á—ñ–ø–∞–Ω–æ) ===
async function handleTelegramUser(user) {
  document.getElementById("telegram-card").style.display = "none";
  document.getElementById("user-card").style.display = "block";
  document.getElementById("hello-line").innerText = `–í—ñ—Ç–∞—é, ${user.first_name || ""} ${user.last_name || ""}`.trim();
  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbyrCxL8N7w1XC3JDU-A1QMlZn8NKs5QKaS1vg-TRjijk_zI00i_y5KP-N5_VNjUA17xyA/exec?user_id=" + encodeURIComponent(user.id));
    const json = await res.json();
    if (json.isPro) {
      const d = json.expireDate?.split("T")[0]?.split("-").reverse().join(".");
      document.getElementById("pro-status").innerHTML = `‚úÖ PRO –∞–∫—Ç–∏–≤–Ω–∏–π –¥–æ <b>${d}</b>`;
    } else {
      document.getElementById("pro-status").innerText = "‚ùå –ë–µ–∑ PRO";
    }
  } catch (err) {
    document.getElementById("pro-status").innerText = "‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ PRO";
  }
  loadMessagesForUser(user.id);
}

function onTelegramAuth(user) {
  localStorage.setItem("telegram_user", JSON.stringify(user));
  handleTelegramUser(user);
}

window.addEventListener("DOMContentLoaded", () => {
  const savedUser = localStorage.getItem("telegram_user");
  if (savedUser) {
    try {
      const user = JSON.parse(savedUser);
      document.getElementById("telegram-card").style.display = "none";
      handleTelegramUser(user);
    } catch {}
  }
});

// === üì© –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è ===
async function loadMessagesForUser(userId) {
  const box = document.getElementById("messagesList");
  box.innerHTML = `<p style="color:#888;font-size:14px;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p>`;
  const { data, error } = await supabase
    .from("user_messages")
    .select("*")
    .eq("user_id", String(userId))
    .order("created_at", { ascending:false });
  if (error) { box.innerHTML = `<p>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</p>`; return; }
  if (!data?.length) { box.innerHTML = `<p>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å</p>`; return; }
  const lastCount = Number(localStorage.getItem("last_msg_count") || 0);
  localStorage.setItem("last_msg_count", data.length);
  const isNew = data.length > lastCount;
  if (isNew) {
    const badge = document.createElement("div");
    badge.textContent = "üÜï –ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!";
    badge.style.cssText = "position:absolute;top:-6px;right:10px;color:#6a5af9;font-size:13px;font-weight:600;animation:pulse 1.5s infinite;";
    document.getElementById("messages-card").appendChild(badge);
  }
  box.innerHTML = "";
  data.forEach(m => {
    const card = document.createElement("div");
    card.className = "message-item" + (isNew ? " new" : "");
    card.innerHTML = `
      <div class="message-header">
        <b>${m.title || "–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è"}</b>
        <small style="color:#777;">${new Date(m.created_at).toLocaleString()}</small>
      </div>
      <p style="margin:6px 0;">${m.body || ""}</p>
      ${m.from_name ? `<small style="color:#6a5af9;">‚Äî ${m.from_name}</small>` : ""}
      <button class="msg-delete">üóë –í–∏–¥–∞–ª–∏—Ç–∏</button>`;
    card.querySelector(".msg-delete").addEventListener("click", async ()=>{
      if (!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?")) return;
      await supabase.from("user_messages").delete().eq("id", m.id);
      card.remove();
    });
    box.appendChild(card);
  });
}

// === –ó–∞–∫–ª–∞–¥–∫–∏ ===
function getLocalBookmarks(){
  try{return JSON.parse(localStorage.getItem("bookmarks")||"[]");}catch{return[];}
}
function renderBookmarksInProfile(){
  const card=document.getElementById("favorites-card");
  const listEl=document.getElementById("favoritesList");
  const list=getLocalBookmarks();
  listEl.innerHTML="";
  if(!list.length){listEl.innerHTML="<p style='color:#777;'>–ü–æ–∫–∏ —â–æ –ø–æ—Ä–æ–∂–Ω—å–æ üïØÔ∏è</p>";return;}
  list.forEach(item=>{
    const id=item.id||"",title=item.title||"–ë–µ–∑ –Ω–∞–∑–≤–∏",poster=item.poster||"https://via.placeholder.com/150x210?text=No+Image";
    const type=item.type||"–§—ñ–ª—å–º";
    let href=`film.html?id=${encodeURIComponent(id)}`;
    if(type==="–°–µ—Ä—ñ–∞–ª") href=`series.html?title=${encodeURIComponent(title)}`;
    if(type==="–ú—É–ª—å—Ç—Å–µ—Ä—ñ–∞–ª") href=`multseries.html?title=${encodeURIComponent(title)}`;
    const div=document.createElement("div");
    div.className="bookmark-card";
    div.innerHTML=`<img src="${poster}" alt="${title}"><p>${title}</p>`;
    div.onclick=()=>window.location.href=href;
    listEl.appendChild(div);
  });
}
document.getElementById("favClearBtn")?.addEventListener("click",()=>{
  if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∑–∞–∫–ª–∞–¥–∫–∏?"))return;
  localStorage.removeItem("bookmarks");
  renderBookmarksInProfile();
});
window.addEventListener("DOMContentLoaded",renderBookmarksInProfile);
</script>

</body>
</html>
